# AmazonGen 产品需求文档 (PRD)

## 1. 产品概述

### 1.1 产品定位
**AmazonGen（亚马逊产品图生成套件）** 是一款专为电商卖家设计的AI自动化图片生成工具。通过Google Gemini多模态AI能力，帮助用户从一张简单的产品原图，快速生成一套高质量、多场景的亚马逊产品展示图（Listing Images）。

### 1.2 目标用户
- **主要用户**：亚马逊电商卖家、产品运营人员、设计师
- **次要用户**：电商平台运营团队、产品摄影工作室

### 1.3 核心价值
- **自动化**：一键生成多张不同场景的图片，无需人工PS
- **一致性**：确保生成图中的产品主体与原图保持高度一致
- **高质量**：利用Gemini Pro/Flash模型生成商业摄影级别的图片
- **效率提升**：将传统需要数小时的产品图制作流程缩短至几分钟

### 1.4 产品愿景
成为电商卖家首选的AI产品图生成工具，让每个卖家都能轻松制作专业级产品展示图。

---

## 2. 核心概念

### 2.1 产品面具 (Product Mask)
**定义**：产品面具是针对某一类产品的生成模板配置，代表了一条产品线或一种特定的营销风格。

**特点**：
- 每个面具包含多个镜头定义
- 可配置提示词优化模型（Gemini Flash 或 Pro）
- 支持公共面具（所有用户可见）和私有面具（用户专属）

**示例**：
- "登山靴 V1" - 户外运动鞋类产品
- "夏季连衣裙 - 海滩风" - 女装类产品
- "咖啡机 - 高级家用" - 小家电类产品

### 2.2 镜头定义 (Image Definition)
**定义**：镜头是面具下的具体图片生成任务，定义了单张图片的视角和场景。

**组成要素**：
- **名称**：如 "白底主图"、"厨房场景图"、"模特佩戴图"
- **场景需求**：简短的中文描述，如 "放在大理石台面上，晨光，温馨氛围"

**逻辑关系**：
- 一个面具包含多个镜头（例如 1 个面具 = 5 张不同角度/场景的图）
- 用户生成时可以选择性地执行部分镜头

### 2.3 生成历史 (Generation History)
**定义**：记录用户每次生成操作的完整信息，包括原图、生成图、使用的提示词、模型等。

**用途**：
- 追溯生成记录
- 支持重新生成和调整
- 数据分析与优化

---

## 3. 用户角色与权限

### 3.1 管理员 (Admin)
**权限**：
- ✅ 所有普通用户权限
- ✅ 创建、编辑、删除公共面具
- ✅ 管理员工账号（创建、删除）
- ✅ 配置系统API Keys
- ✅ 查看所有用户数据（可选）

**典型场景**：
- 运营负责人配置产品线模板
- 系统管理员管理团队账号

### 3.2 普通用户 (User)
**权限**：
- ✅ 使用公共面具生成图片
- ✅ 查看个人生成历史
- ✅ 下载生成的图片
- ✅ 调整和重新生成图片

**典型场景**：
- 产品运营人员日常生成产品图
- 设计师快速制作多场景展示图

---

## 4. 核心业务流程

### 4.1 配置阶段（管理员操作）

#### 4.1.1 创建产品面具
**流程**：
1. 管理员进入"后台管理" → "公共面具"
2. 输入面具名称（如"咖啡机系列"）
3. 选择提示词优化模型（Gemini Flash 或 Pro）
4. 点击"创建面具"

**输出**：创建一个空的面具模板

#### 4.1.2 添加镜头定义
**流程**：
1. 选择已创建的面具
2. 输入镜头名称（如"白底主图"）
3. 输入场景需求描述（如"专业电商白底图，展示产品全貌"）
4. 点击"保存定义"
5. 重复步骤2-4，添加多个镜头

**输出**：一个完整配置的面具（包含多个镜头定义）

**示例配置**：
```
面具：咖啡机系列
├── 镜头1：白底主图 - "专业电商白底图，展示产品全貌"
├── 镜头2：厨房场景 - "放在厨房大理石台面上，晨光，温馨氛围"
├── 镜头3：使用场景 - "咖啡从机器中流出，蒸汽缭绕，生活化场景"
└── 镜头4：细节特写 - "产品细节特写，突出质感"
```

### 4.2 生产阶段（用户操作）

#### 4.2.1 选择面具和镜头
**流程**：
1. 用户进入"生成器"界面
2. 从下拉列表选择产品面具
3. 查看该面具下的所有镜头定义
4. 使用搜索功能筛选镜头（可选）
5. 勾选需要生成的镜头（支持多选、全选）

**输出**：确定要生成的镜头列表

#### 4.2.2 上传产品原图
**流程**：
1. 点击上传区域
2. 选择产品原图（支持手机拍摄或简单白底图）
3. 系统自动进行背景移除处理
   - 调用Gemini Flash模型识别产品主体
   - 移除背景，提取纯净产品图
   - 显示处理进度
4. 预览处理后的产品图

**输出**：处理后的产品主体图（base64格式）

#### 4.2.3 填写产品参数（可选）
**流程**：
1. 输入产品尺寸（宽×高，单位：cm，必填）
2. 输入应用场景（如"桌面/户外"，可选）
3. 输入产品规格（如"50mm口径"，可选）

**输出**：产品规格信息（用于优化生成提示词）

#### 4.2.4 选择生图模型
**流程**：
1. 从下拉列表选择生图模型：
   - Gemini 2.5 Flash Image（快速版，成本低）
   - Gemini 3.0 Pro Image（高清版，质量高）
   - Gemini 2.5 Flash (OpenRouter)（备用选项）
2. 点击"开始生成"

**输出**：触发批量生成任务

#### 4.2.5 图片生成流程
**流程**：
1. **任务创建**：为每个选中的镜头创建一个生成任务
2. **提示词构建**：
   - 系统将"产品主体图" + "镜头场景描述" + "产品参数"组合
   - 构建结构化的英文商业摄影Prompt
3. **图片生成**：
   - 调用选定的Gemini图像生成模型
   - 将产品主体融入场景
   - 生成最终场景图
4. **状态更新**：
   - 实时显示生成进度（"构思中..." → "绘制中..." → "完成"）
   - 支持并行生成多个镜头

**输出**：多张高质量的产品场景图

#### 4.2.6 预览与下载
**流程**：
1. **查看结果**：
   - 在右侧网格中查看所有生成结果
   - 点击图片查看大图和详情
   - 查看使用的Prompt（调试用）
2. **单张操作**：
   - 点击图片查看详情
   - 下载单张图片
   - 调整重绘（修改提示词或模型）
3. **批量操作**：
   - 勾选多张图片
   - 批量下载（自动打包为ZIP）
4. **重新生成**：
   - 对失败的图片点击"重新生成"
   - 对满意的图片点击"生成新版本"（基于当前图继续优化）

**输出**：用户满意的产品图集合

---

## 5. 功能模块详细说明

### 5.1 登录认证模块

#### 5.1.1 用户登录
**功能描述**：用户通过用户名和密码登录系统

**输入**：
- 用户名（必填）
- 密码（必填）

**处理逻辑**：
1. 验证用户名和密码
2. 生成JWT Token（有效期7天）
3. 返回用户信息和Token

**输出**：
- 登录成功：跳转到用户面板或管理面板（根据角色）
- 登录失败：显示错误提示

**默认账号**：
- 管理员：`admin` / `admin`（首次部署后需修改）

#### 5.1.2 自动认证
**功能描述**：页面刷新时自动验证Token有效性

**处理逻辑**：
1. 读取本地存储的Token
2. 调用后端API验证Token
3. 有效则自动登录，无效则跳转登录页

### 5.2 用户面板模块（生成器）

#### 5.2.1 面具选择器
**功能描述**：显示所有公共面具，支持搜索和筛选

**UI组件**：
- 下拉选择框：显示面具名称和镜头数量
- 搜索框：实时搜索镜头定义
- 镜头列表：网格显示，支持多选

**交互**：
- 选择面具后自动加载该面具的镜头定义
- 支持全选/清空镜头
- 显示已选镜头数量

#### 5.2.2 图片上传区域
**功能描述**：上传产品原图并自动处理

**UI组件**：
- 拖拽上传区域
- 图片预览
- 处理进度指示器

**处理流程**：
1. 用户选择图片文件
2. 转换为base64格式
3. 调用背景移除API
4. 显示处理后的产品图

**错误处理**：
- 背景移除失败时使用原图
- 显示错误提示

#### 5.2.3 产品参数表单
**功能描述**：收集产品规格信息

**字段**：
- 产品尺寸（宽×高，cm，必填）
- 应用场景（文本，可选）
- 产品规格（文本，可选，默认单位mm）

**验证**：
- 尺寸为必填项
- 尺寸必须为数字

#### 5.2.4 生图模型选择器
**功能描述**：选择用于图像生成的AI模型

**选项**：
- Gemini 2.5 Flash Image（快速，成本低）
- Gemini 3.0 Pro Image（高质量）
- Gemini 2.5 Flash (OpenRouter)（备用）

**默认值**：Gemini 2.5 Flash Image

#### 5.2.5 生成按钮
**功能描述**：触发批量图片生成

**启用条件**：
- ✅ 已选择面具
- ✅ 已上传产品图
- ✅ 已选择至少一个镜头
- ✅ 已填写产品尺寸
- ✅ 不在生成中

**处理逻辑**：
1. 验证所有必填项
2. 创建生成任务列表
3. 并行执行生成任务
4. 实时更新任务状态

#### 5.2.6 结果展示区
**功能描述**：展示所有生成结果

**UI组件**：
- 网格布局（响应式：2-5列）
- 图片卡片（包含缩略图、名称、状态）
- 批量操作栏（浮动）

**卡片信息**：
- 镜头名称
- 所属面具名称
- 生成时间
- 使用的模型
- 关联原图（小图标）
- 生成状态（加载中/完成/失败）

**交互**：
- 点击图片：打开详情模态框
- 悬停显示操作按钮（查看、下载）
- 支持多选（复选框）
- 批量下载（ZIP打包）

#### 5.2.7 图片详情模态框
**功能描述**：查看单张图片的详细信息

**显示内容**：
- 大图预览（左侧，2/3宽度）
- 图片信息（右侧，1/3宽度）：
  - 镜头名称
  - 所属面具
  - 关联原图
  - 生成时间
  - 使用的模型
- 调整重绘区域：
  - 调整指令输入框（可选）
  - 模型选择器
  - "生成新版本"按钮

**操作**：
- 下载原图
- 调整重绘（基于当前图生成新版本）
- 关闭模态框

### 5.3 管理面板模块

#### 5.3.1 公共面具管理
**功能描述**：管理员创建和管理产品面具

**功能列表**：
- ✅ 创建新面具
- ✅ 编辑面具信息（名称、模型）
- ✅ 删除面具
- ✅ 查看面具列表
- ✅ 添加镜头定义
- ✅ 编辑镜头定义
- ✅ 删除镜头定义

**UI布局**：
- 左侧：面具列表（可滚动）
- 右侧：选中面具的详细信息编辑区

**面具创建流程**：
1. 输入面具名称
2. 点击"创建"按钮
3. 自动选中新创建的面具

**镜头定义添加流程**：
1. 选择面具
2. 输入镜头名称
3. 输入场景需求描述
4. 点击"保存定义"
5. 自动添加到镜头列表

**镜头定义编辑流程**：
1. 点击镜头卡片上的"编辑"按钮
2. 进入编辑模式（内联编辑）
3. 修改名称或描述
4. 点击"保存"或"取消"

#### 5.3.2 员工账号管理
**功能描述**：管理员管理团队成员账号

**功能列表**：
- ✅ 创建新用户
- ✅ 删除用户
- ✅ 查看用户列表
- ✅ 批量导入用户（CSV）

**UI组件**：
- 用户创建表单（姓名、密码）
- 用户列表（卡片网格）
- 批量导入按钮
- CSV模板下载

**批量导入流程**：
1. 下载CSV模板
2. 填写用户信息（姓名,密码）
3. 点击"批量导入"
4. 选择CSV文件
5. 系统解析并创建账号
6. 显示导入结果

**CSV格式**：
```csv
姓名,密码
张三,123456
李四,abcdef
```

#### 5.3.3 系统设置
**功能描述**：配置AI服务的API Keys

**功能列表**：
- ✅ 配置Google Gemini API Key
- ✅ 配置OpenRouter API Key
- ✅ 显示/隐藏密钥（安全）

**UI组件**：
- Google API Key输入框（密码类型）
- OpenRouter API Key输入框（密码类型）
- 显示/隐藏切换按钮
- 保存按钮

**存储方式**：
- 存储在数据库（用户级别）
- 前端缓存（临时）

**安全措施**：
- 密码输入框（默认隐藏）
- 支持显示/隐藏切换
- 密钥验证（Google Key需以"AIza"开头）

### 5.4 生成历史模块

#### 5.4.1 历史记录列表
**功能描述**：显示用户的所有生成历史

**数据来源**：
- 后端API：`GET /api/history`
- 前端状态：当前会话的生成结果

**显示内容**：
- 生成时间（倒序）
- 镜头名称
- 所属面具
- 原图缩略图
- 生成图缩略图
- 使用的模型

**分页**：
- 默认每页50条
- 支持分页导航

#### 5.4.2 自动保存
**功能描述**：生成完成后自动保存到历史记录

**触发时机**：
- 图片生成成功
- 图片URL可用
- 尚未保存到后端

**保存内容**：
- 面具ID
- 镜头ID和名称
- 原图URL（base64）
- 生成图URL
- 优化后的Prompt
- 使用的模型
- 生成时间

### 5.5 API集成模块

#### 5.5.1 Google Gemini API
**功能描述**：调用Google原生Gemini API

**使用场景**：
- 提示词优化（Gemini Flash/Pro）
- 图像生成（Gemini Flash Image/Pro Image）
- 背景移除（Gemini Flash Image）

**API Key管理**：
- 从后端数据库获取
- 支持环境变量fallback
- 缓存机制（避免重复请求）

#### 5.5.2 OpenRouter API
**功能描述**：通过OpenRouter调用Gemini模型（备用）

**使用场景**：
- Google API Key不可用时自动fallback
- 支持Gemini 3 Pro Preview等高级模型

**模型映射**：
- `gemini-2.5-flash` → `google/gemini-2.5-flash`
- `gemini-3-pro-preview` → `google/gemini-3-pro-preview`

---

## 6. 技术架构

### 6.1 前端架构
- **框架**：React 19 + TypeScript
- **构建工具**：Vite 6
- **UI库**：Tailwind CSS + Lucide React Icons
- **状态管理**：React Hooks (useState, useEffect)
- **HTTP客户端**：Fetch API（封装为apiService）

### 6.2 后端架构
- **运行时**：Node.js + TypeScript
- **框架**：Express.js
- **数据库**：SQLite（本地JSON数据库，lowdb）
- **认证**：JWT (jsonwebtoken)
- **密码加密**：bcryptjs

### 6.3 AI服务集成
- **Google Gemini SDK**：`@google/genai`
- **OpenRouter SDK**：`@openrouter/sdk`
- **模型支持**：
  - Gemini 2.5 Flash（文本生成）
  - Gemini 2.5 Flash Image（图像生成）
  - Gemini 3.0 Pro Preview（高级文本）
  - Gemini 3.0 Pro Image Preview（高级图像）

### 6.4 数据存储
- **用户数据**：数据库（users表）
- **面具配置**：数据库（product_masks表 + image_definitions表）
- **生成历史**：数据库（generation_history表）
- **API Keys**：数据库（api_keys表，用户级别）

---

## 7. 数据模型

### 7.1 用户表 (users)
```sql
- id: VARCHAR(36) PRIMARY KEY
- name: VARCHAR(100) UNIQUE
- password_hash: VARCHAR(255)
- role: ENUM('admin', 'user')
- avatar: VARCHAR(255)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### 7.2 产品面具表 (product_masks)
```sql
- id: VARCHAR(36) PRIMARY KEY
- name: VARCHAR(200)
- prompt_model: VARCHAR(100)
- is_public: BOOLEAN
- created_by: VARCHAR(36) FOREIGN KEY → users.id
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### 7.3 镜头定义表 (image_definitions)
```sql
- id: VARCHAR(36) PRIMARY KEY
- mask_id: VARCHAR(36) FOREIGN KEY → product_masks.id
- name: VARCHAR(200)
- prompt: TEXT
- sort_order: INT
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### 7.4 生成历史表 (generation_history)
```sql
- id: VARCHAR(36) PRIMARY KEY
- user_id: VARCHAR(36) FOREIGN KEY → users.id
- mask_id: VARCHAR(36) FOREIGN KEY → product_masks.id
- definition_id: VARCHAR(36) FOREIGN KEY → image_definitions.id
- definition_name: VARCHAR(200)
- source_image_url: VARCHAR(500)
- generated_image_url: VARCHAR(500)
- prompt: TEXT
- optimized_prompt: TEXT
- model: VARCHAR(100)
- status: ENUM('pending', 'processing', 'completed', 'failed')
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

### 7.5 API Keys表 (api_keys)
```sql
- id: VARCHAR(36) PRIMARY KEY
- user_id: VARCHAR(36) FOREIGN KEY → users.id UNIQUE
- google_api_key: VARCHAR(500)
- openrouter_api_key: VARCHAR(500)
- created_at: TIMESTAMP
- updated_at: TIMESTAMP
```

---

## 8. API接口规范

### 8.1 认证接口

#### POST `/api/auth/login`
**功能**：用户登录

**请求体**：
```json
{
  "name": "admin",
  "password": "admin"
}
```

**响应**：
```json
{
  "token": "jwt-token-here",
  "user": {
    "id": "user-id",
    "name": "admin",
    "role": "admin",
    "avatar": "👑",
    "createdAt": 1234567890
  }
}
```

#### POST `/api/auth/register`
**功能**：注册新用户（需要管理员权限）

### 8.2 用户管理接口

#### GET `/api/users/me`
**功能**：获取当前用户信息

#### GET `/api/users`
**功能**：获取所有用户列表（仅管理员）

#### POST `/api/users`
**功能**：创建新用户（仅管理员）

#### DELETE `/api/users/:userId`
**功能**：删除用户（仅管理员）

### 8.3 面具管理接口

#### GET `/api/masks`
**功能**：获取所有公共面具

#### POST `/api/masks`
**功能**：创建新面具（仅管理员）

#### PUT `/api/masks/:maskId`
**功能**：更新面具信息（仅管理员）

#### DELETE `/api/masks/:maskId`
**功能**：删除面具（仅管理员）

#### POST `/api/masks/:maskId/definitions`
**功能**：添加镜头定义（仅管理员）

#### PUT `/api/masks/definitions/:definitionId`
**功能**：更新镜头定义（仅管理员）

#### DELETE `/api/masks/definitions/:definitionId`
**功能**：删除镜头定义（仅管理员）

### 8.4 生成历史接口

#### GET `/api/history?page=1&limit=50`
**功能**：获取当前用户的生成历史

#### POST `/api/history`
**功能**：创建生成历史记录

#### DELETE `/api/history/:historyId`
**功能**：删除历史记录

### 8.5 API Key管理接口

#### GET `/api/api-keys`
**功能**：获取当前用户的API Keys

#### PUT `/api/api-keys`
**功能**：更新当前用户的API Keys

---

## 9. 用户体验设计

### 9.1 界面布局
- **登录页**：居中卡片式设计，简洁现代
- **用户面板**：左右分栏（控制区 + 结果区）
- **管理面板**：左侧导航 + 右侧内容区

### 9.2 交互设计
- **实时反馈**：所有操作都有loading状态
- **错误处理**：友好的错误提示信息
- **快捷操作**：支持键盘快捷键（Enter提交）
- **批量操作**：支持多选和批量下载

### 9.3 视觉设计
- **主色调**：橙色（#F97316）作为强调色
- **字体**：系统默认字体栈
- **图标**：Lucide React Icons
- **响应式**：支持不同屏幕尺寸

---

## 10. 性能要求

### 10.1 响应时间
- 页面加载：< 2秒
- API响应：< 1秒（非AI操作）
- 图片生成：< 30秒/张（取决于模型）

### 10.2 并发处理
- 支持并行生成多个镜头
- 单个用户最多同时生成10个任务

### 10.3 数据量
- 单次生成最多选择20个镜头
- 历史记录支持分页（每页50条）

---

## 11. 安全要求

### 11.1 认证安全
- 密码使用bcrypt加密存储
- JWT Token有效期7天
- Token存储在localStorage（前端）

### 11.2 API安全
- 所有API请求需要Bearer Token认证
- API Keys存储在数据库，不暴露给前端
- 支持CORS配置

### 11.3 数据安全
- 用户只能访问自己的数据
- 管理员可以管理所有数据
- 删除操作需要二次确认

---

## 12. 未来规划

### 12.1 短期优化（1-3个月）
- [ ] 图片存储优化（OSS/S3集成）
- [ ] 批量导入优化（支持Excel格式）
- [ ] 生成历史搜索和筛选
- [ ] 图片质量评分和推荐

### 12.2 中期功能（3-6个月）
- [ ] 私有面具功能（用户专属模板）
- [ ] 团队协作功能（共享面具和结果）
- [ ] 图片编辑功能（基础调整）
- [ ] 数据统计分析（生成量、成功率等）

### 12.3 长期愿景（6-12个月）
- [ ] 多平台支持（eBay、Shopify等）
- [ ] AI智能推荐（自动推荐最佳场景）
- [ ] 移动端应用（iOS/Android）
- [ ] API开放平台（第三方集成）

---

## 13. 附录

### 13.1 术语表
- **面具 (Mask)**：产品模板配置
- **镜头 (Definition)**：单张图片的生成任务
- **Prompt**：AI图像生成的文本指令
- **背景移除 (BG Removal)**：自动提取产品主体的过程

### 13.2 参考文档
- [产品业务文档](./product_overview.md)
- [后端API文档](../backend/README.md)
- [集成指南](../INTEGRATION_GUIDE.md)

### 13.3 版本历史
- **v1.0.0** (2024-01)：初始版本
  - 基础功能实现
  - 用户认证和权限管理
  - 面具和镜头管理
  - 图片生成和历史记录

---

**文档版本**：1.0.0  
**最后更新**：2024-01  
**维护者**：产品团队

