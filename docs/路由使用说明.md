# 路由使用说明

## 概述

项目已集成 React Router，使用路由管理页面导航，支持：
- 路由保护（需要登录才能访问）
- 角色权限控制（管理员专属页面）
- 登录后重定向
- URL导航和浏览器历史记录

## 路由配置

### 路由列表

| 路径 | 组件 | 权限要求 | 说明 |
|------|------|----------|------|
| `/login` | LoginPanel | 公开 | 登录页面 |
| `/` | UserPanel | 需要登录 | 用户面板（生成器） |
| `/admin` | AdminPanel | 需要管理员权限 | 管理面板 |
| `*` | Navigate to `/` | - | 404重定向到首页 |

### 路由结构

```tsx
<BrowserRouter>
  <AuthProvider>
    <MaskProvider>
      <GenerationProvider>
        <Routes>
          <Route path="/login" element={<LoginRedirect />} />
          <Route path="/" element={<ProtectedRoute><UserPanel /></ProtectedRoute>} />
          <Route path="/admin" element={<ProtectedRoute requiredRole={UserRole.ADMIN}><AdminLayout /></ProtectedRoute>} />
          <Route path="*" element={<Navigate to="/" replace />} />
        </Routes>
      </GenerationProvider>
    </MaskProvider>
  </AuthProvider>
</BrowserRouter>
```

## 核心组件

### 1. ProtectedRoute - 路由保护组件

保护需要登录才能访问的路由，支持角色权限控制。

```tsx
import { ProtectedRoute } from './components/ProtectedRoute';

// 基础保护（只需要登录）
<ProtectedRoute>
  <YourComponent />
</ProtectedRoute>

// 角色保护（需要管理员权限）
<ProtectedRoute requiredRole={UserRole.ADMIN}>
  <AdminComponent />
</ProtectedRoute>
```

**功能：**
- 检查用户是否登录
- 未登录自动重定向到 `/login`
- 支持角色权限验证
- 显示加载状态

### 2. NavigationBar - 全局导航栏

显示在页面右上角的导航栏，包含用户信息、页面切换和退出登录。

**功能：**
- 显示当前用户信息
- 管理员可以切换"生成器"和"后台管理"
- 退出登录按钮
- 根据当前路由高亮对应按钮

### 3. LoginRedirect - 登录重定向

处理登录页面的重定向逻辑。

**功能：**
- 已登录用户访问 `/login` 时自动重定向
- 根据用户角色重定向到对应页面
- 支持从其他页面跳转过来（保存来源路径）

## 使用方法

### 在组件中使用路由导航

```tsx
import { useNavigate, useLocation } from 'react-router-dom';

const MyComponent = () => {
  const navigate = useNavigate();
  const location = useLocation();

  // 编程式导航
  const handleClick = () => {
    navigate('/admin'); // 跳转到管理面板
  };

  // 带状态导航
  const handleLogin = () => {
    navigate('/login', { 
      state: { from: location.pathname } // 保存来源路径
    });
  };

  // 返回上一页
  const handleBack = () => {
    navigate(-1);
  };

  return (
    <button onClick={handleClick}>跳转</button>
  );
};
```

### 使用 Link 组件（声明式导航）

```tsx
import { Link } from 'react-router-dom';

<Link to="/admin">管理面板</Link>
<Link to="/">生成器</Link>
```

### 获取路由参数和状态

```tsx
import { useParams, useSearchParams, useLocation } from 'react-router-dom';

const MyComponent = () => {
  // 获取路径参数（如 /user/:id）
  const { id } = useParams();

  // 获取查询参数（如 ?page=1&limit=10）
  const [searchParams] = useSearchParams();
  const page = searchParams.get('page');

  // 获取路由状态（从 navigate 传递的 state）
  const location = useLocation();
  const from = location.state?.from;

  return <div>...</div>;
};
```

## 路由保护流程

### 1. 访问受保护路由

```
用户访问 /admin
  ↓
ProtectedRoute 检查登录状态
  ↓
未登录 → 重定向到 /login（保存来源路径）
  ↓
已登录 → 检查角色权限
  ↓
权限不足 → 重定向到 /
  ↓
权限足够 → 渲染组件
```

### 2. 登录流程

```
用户在 /login 页面登录
  ↓
登录成功
  ↓
检查来源路径（location.state.from）
  ↓
有来源路径 → 重定向到来源路径
  ↓
无来源路径 → 根据角色重定向
  ↓
管理员 → /admin
普通用户 → /
```

## 最佳实践

### 1. 路由导航

```tsx
// ✅ 推荐：使用 navigate
const navigate = useNavigate();
navigate('/admin');

// ❌ 不推荐：直接修改 window.location
window.location.href = '/admin';
```

### 2. 路由保护

```tsx
// ✅ 推荐：使用 ProtectedRoute
<Route path="/admin" element={
  <ProtectedRoute requiredRole={UserRole.ADMIN}>
    <AdminPanel />
  </ProtectedRoute>
} />

// ❌ 不推荐：在组件内部检查权限
const AdminPanel = () => {
  if (!user || user.role !== 'admin') {
    return <Navigate to="/" />;
  }
  // ...
};
```

### 3. 登录后重定向

```tsx
// ✅ 推荐：保存来源路径
navigate('/login', { state: { from: location.pathname } });

// ✅ 推荐：登录后根据来源重定向
const from = location.state?.from || '/';
navigate(from, { replace: true });
```

## 添加新路由

### 步骤1：创建组件

```tsx
// components/NewPage.tsx
export const NewPage: React.FC = () => {
  return <div>新页面</div>;
};
```

### 步骤2：添加路由配置

```tsx
// App.tsx
import { NewPage } from './components/NewPage';

<Route
  path="/new-page"
  element={
    <ProtectedRoute>
      <NewPage />
    </ProtectedRoute>
  }
/>
```

### 步骤3：添加导航链接（可选）

```tsx
// 在 NavigationBar 或其他组件中
<Link to="/new-page">新页面</Link>
```

## 常见问题

### Q: 如何实现404页面？

A: 使用通配符路由：

```tsx
<Route path="*" element={<NotFoundPage />} />
```

### Q: 如何实现嵌套路由？

A: 使用 `<Outlet />` 组件：

```tsx
<Route path="/admin" element={<AdminLayout />}>
  <Route path="users" element={<UserList />} />
  <Route path="settings" element={<Settings />} />
</Route>
```

### Q: 如何实现路由懒加载？

A: 使用 React.lazy：

```tsx
const AdminPanel = React.lazy(() => import('./components/AdminPanel'));

<Route path="/admin" element={
  <Suspense fallback={<div>加载中...</div>}>
    <ProtectedRoute requiredRole={UserRole.ADMIN}>
      <AdminPanel />
    </ProtectedRoute>
  </Suspense>
} />
```

## 总结

路由系统提供了：
- ✅ 清晰的URL结构
- ✅ 浏览器历史记录支持
- ✅ 路由保护和权限控制
- ✅ 登录后重定向
- ✅ 易于扩展和维护

所有路由都通过 `App.tsx` 统一管理，便于维护和扩展。

